

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>WRF Scaling Results &mdash; WRF Benchmarks 0.0.1 documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" /> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="#" class="icon icon-home"> WRF Benchmarks
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <!-- Local TOC -->
              <div class="local-toc"><ul>
<li><a class="reference internal" href="#">WRF Scaling Results</a><ul>
<li><a class="reference internal" href="#conclusion">Conclusion</a></li>
<li><a class="reference internal" href="#hybrid-runs-summary">Hybrid Runs Summary</a></li>
<li><a class="reference internal" href="#compiler-option-67-flags">Compiler Option 67 flags</a></li>
</ul>
</li>
<li><a class="reference internal" href="#hyperthreading-results">HyperThreading Results</a><ul>
<li><a class="reference internal" href="#mvapich">Mvapich</a></li>
<li><a class="reference internal" href="#misc-hybrid-runs">Misc Hybrid Runs</a></li>
</ul>
</li>
</ul>
</div>
            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="#">WRF Benchmarks</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="#">Docs</a> &raquo;</li>
        
      <li>WRF Scaling Results</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/index.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="wrf-scaling-results">
<h1><a class="toc-backref" href="#id1">WRF Scaling Results</a><a class="headerlink" href="#wrf-scaling-results" title="Permalink to this headline">¶</a></h1>
<div class="admonition attention">
<p class="first admonition-title">Attention</p>
<p class="last">Under revision</p>
</div>
<div class="contents topic" id="table-of-contents">
<p class="topic-title first">Table of Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#wrf-scaling-results" id="id1">WRF Scaling Results</a><ul>
<li><a class="reference internal" href="#conclusion" id="id2">Conclusion</a></li>
<li><a class="reference internal" href="#hybrid-runs-summary" id="id3">Hybrid Runs Summary</a></li>
<li><a class="reference internal" href="#compiler-option-67-flags" id="id4">Compiler Option 67 flags</a></li>
</ul>
</li>
<li><a class="reference internal" href="#hyperthreading-results" id="id5">HyperThreading Results</a><ul>
<li><a class="reference internal" href="#mvapich" id="id6">Mvapich</a></li>
<li><a class="reference internal" href="#misc-hybrid-runs" id="id7">Misc Hybrid Runs</a></li>
</ul>
</li>
</ul>
</div>
<p>Below graph gives the summary for all simulations with various compilers and libraries.
The aim for these performance benchmarks can be summarized as :</p>
<blockquote>
<div><ul class="simple">
<li>“Is it possible to solve a problem with such-and-such resolution in a timely manner?”</li>
<li>“If I use more cores I will have the results more quickly, but with this resolution will my run be in the efficient strong-scaling regime, an intermediate one, or in the very inefficient one dominated by I/O and initialization instead of computing?”</li>
</ul>
</div></blockquote>
<dl class="docutils">
<dt>Configurations::</dt>
<dd><ul class="first last simple">
<li>Compilers : Intel, GNU</li>
<li>MPI  : mpt,mvapich</li>
<li>Cases : Katrina 1km, Katrina 3km</li>
</ul>
</dd>
</dl>
<a class="reference internal image-reference" href="_images/all_mpi.svg"><img alt="_images/all_mpi.svg" src="_images/all_mpi.svg" width="400px" /></a>
<div class="section" id="conclusion">
<h2><a class="toc-backref" href="#id2">Conclusion</a><a class="headerlink" href="#conclusion" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><ul class="simple">
<li>Intel 18.0.1 (latest) + MPT 2.18 gives the best performance.</li>
</ul>
</div></blockquote>
<dl class="docutils">
<dt><cite>Yellowstone&lt;https://www2.cisl.ucar.edu/software/community-models/wrf-scaling-and-timing&gt;</cite></dt>
<dd><ul class="first">
<li><p class="first">As you can see, there are three regimes:</p>
<blockquote>
<div><ul class="simple">
<li>large number of grid points per core - Total grid points / core &gt; 104 (small core count)</li>
<li>intermediate number of grid points per core - 104 &lt; Total grid points / core &lt; 10^4 (intermediate core count)</li>
<li>small number of grid points per core - Total grid points / core &lt; 104 (large core count)</li>
</ul>
</div></blockquote>
</li>
</ul>
<p>For a small number of cores, the WRF computation kernel is in a strong scaling regime. Increasing the core count will make the simulation go faster while it consumes approximately the same amount of core-hours (ignoring time spent in initialization and I/O). Time-to-solution will also depend on the wait in queue, which may be larger for larger jobs.</p>
<p class="last">For an intermediate number of cores, WRF scaling increasingly departs from linear strong scaling. Running the same simulation on larger core counts will require more core-hours even though it will still run faster (again, ignoring time spent in initialization, I/O, and wait in queue).</p>
</dd>
</dl>
<p>We do not recommend running WRF on extremely large core counts, because in this regime the speed benefits diminish, the time will be dominated by initialization and I/O (as well as wait in queue), and there will be larger core-hours charges for solving the same problem.</p>
</div>
<div class="section" id="hybrid-runs-summary">
<h2><a class="toc-backref" href="#id3">Hybrid Runs Summary</a><a class="headerlink" href="#hybrid-runs-summary" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>Hybrid runs perform better than pure MPI runs if there is good load balancing across cores.</li>
<li>The below run shows 4 or 6 MPI tasks works best.( Total 72 CPU’s were used)</li>
<li>There are two options available to user to compile WRF with Intel (./configure):
1. Option 15/16 : This is a normal option without any optimization flags
2. Option 66/67. This uses several optimization flags, a summary of which is listed below.</li>
</ul>
<p><strong>Configuration</strong></p>
<blockquote>
<div>Run : WRFV4 Katrina 3km
NCPUS : 72</div></blockquote>
<ul>
<li><p class="first"><strong>WRFV4 Intel 18.0.1 MPT 2.18 OpenMP/MPI Speedup Comparision.</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Note</span> <span class="p">:</span> <span class="mi">36</span><span class="n">mpi</span> <span class="n">means</span> <span class="n">no</span> <span class="n">openmp</span> <span class="n">threads</span><span class="o">.</span>
<span class="n">As</span> <span class="n">we</span> <span class="n">can</span> <span class="n">see</span><span class="p">,</span> <span class="n">hybrid</span> <span class="n">mpi</span> <span class="k">with</span> <span class="mi">4</span> <span class="n">MPI</span> <span class="n">tasks</span> <span class="ow">and</span> <span class="mi">9</span> <span class="n">OpenMP</span> <span class="n">threads</span> <span class="n">performs</span> <span class="n">the</span> <span class="n">best</span><span class="o">.</span> <span class="n">From</span> <span class="n">the</span> <span class="n">last</span> <span class="n">two</span> <span class="n">bars</span><span class="p">,</span> <span class="n">Option</span> <span class="mi">66</span> <span class="n">gives</span> <span class="n">better</span> <span class="n">speedup</span> <span class="n">than</span> <span class="n">option</span> <span class="mf">15.</span>
</pre></div>
</div>
</li>
</ul>
<a class="reference internal image-reference" href="_images/hybrid_mpi_speedup.svg"><img alt="_images/hybrid_mpi_speedup.svg" src="_images/hybrid_mpi_speedup.svg" width="400px" /></a>
<ul class="simple">
<li><strong>WRFV4 Intel 18.0.1 MPT 2.18 OpenMP Comparisions.</strong></li>
</ul>
<a class="reference internal image-reference" href="_images/intel18_openmp_67_speed.svg"><img alt="_images/intel18_openmp_67_speed.svg" src="_images/intel18_openmp_67_speed.svg" width="400px" /></a>
<ul class="simple">
<li><strong>Option 67 gives slightly better simulation speed.</strong></li>
</ul>
<a class="reference internal image-reference" href="_images/Intel17_16vs67.svg"><img alt="_images/Intel17_16vs67.svg" src="_images/Intel17_16vs67.svg" width="400px" /></a>
<ul class="simple">
<li><strong>Option 15 vs Option 66 MPI only comparision</strong></li>
</ul>
<a class="reference internal image-reference" href="_images/15_vs_66.svg"><img alt="_images/15_vs_66.svg" src="_images/15_vs_66.svg" width="400px" /></a>
</div>
<div class="section" id="compiler-option-67-flags">
<h2><a class="toc-backref" href="#id4">Compiler Option 67 flags</a><a class="headerlink" href="#compiler-option-67-flags" title="Permalink to this headline">¶</a></h2>
<p><strong>Flags</strong> : -xHost -fp-model fast=2 -no-heap-arrays -no-prec-div -no-prec-sqrt -fno-common -xCORE-AVX2</p>
<p><strong>xHost</strong> : Tells the compiler to generate instructions for the highest instruction set available on the compilation host processor.</p>
<p><strong>fp-model fast = 2</strong> : Controls the semantics of floating-point calculations. Enables more aggressive optimizations on floating-point data.</p>
<p><strong>-no-heap-arrays</strong>  :  The compiler puts automatic arrays and temporary arrays in the stack storage area.</p>
<p><strong>no-prec-div</strong> :  Improves precision of floating-point divides.  (No) : it enables optimizations that give slightly less precise results than full IEEE division.</p>
<p><strong>no-prec-sqrt</strong> :  The compiler uses a faster but less precise implementation of square root.</p>
<p><strong>no-common</strong> : Option -fno-common tells the compiler to treat common symbols as global definitions. When using this option, you can only have a common variable declared in one module; otherwise, a link time error will occur for multiple defined symbols.</p>
<p><strong>CORE-AVX2</strong> :  expansion of most vector integer SSE and AVX instructions to 256 bits. <cite>NASA</cite> &lt;<a class="reference external" href="https://www.nas.nasa.gov/hecc/support/kb/haswell-processors_492.html">https://www.nas.nasa.gov/hecc/support/kb/haswell-processors_492.html</a>&gt;</p>
</div>
</div>
<div class="section" id="hyperthreading-results">
<h1><a class="toc-backref" href="#id5">HyperThreading Results</a><a class="headerlink" href="#hyperthreading-results" title="Permalink to this headline">¶</a></h1>
<p><strong>Configuration</strong> : WRFV4. Katrina 3km 800x900</p>
<p>Hyperthreading on cheyenne lowers the model performance. Below are a few comparisions with hyperthreading. Some examples of PBS scripts can be found here : [Cheyenne](<a class="reference external" href="https://www2.cisl.ucar.edu/resources/computational-systems/cheyenne/running-jobs/hyper-threading-cheyenne">https://www2.cisl.ucar.edu/resources/computational-systems/cheyenne/running-jobs/hyper-threading-cheyenne</a>)</p>
<div class="admonition hint">
<p class="first admonition-title">Hint</p>
<dl class="last docutils">
<dt>In-case your run requires hyperthreading, it is recommended to specify ncpus = 36 and mpiprocs = 72</dt>
<dd><dl class="first last docutils">
<dt>For e.g in PBS script</dt>
<dd><ul class="first last simple">
<li>#PBS -l select=2:ncpus=36:mpiprocs=72</li>
</ul>
</dd>
</dl>
</dd>
<dt>Observation :</dt>
<dd><p class="first">wrf_stats output shows different result based on how the cores &amp; mpi tasks were specified in the script.
Eg :</p>
<blockquote>
<div><ol class="arabic simple">
<li>#PBS -l select=2:ncpus=72:mpiprocs=72 =&gt;  XxY = 12x12        &amp; CPU’s = 144</li>
<li>#PBS -l select=2:ncpus=36:mpiprocs=72 =&gt;  XxY = 16x18 &amp; CPU’s = 288</li>
</ol>
</div></blockquote>
<p class="last">Note: <em>XxY &amp; CPUs are columns taken from wrf_stats output by running the following command : ./wrf_stats -t -H -d .</em></p>
</dd>
</dl>
</div>
<ul>
<li><p class="first"><strong>Following are speedup comparisions when specifying:</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">PBS</span> <span class="o">-</span><span class="n">l</span> <span class="n">select</span><span class="o">=</span><span class="mi">2</span><span class="p">:</span><span class="n">ncpus</span><span class="o">=</span><span class="mi">72</span><span class="p">:</span><span class="n">mpiprocs</span><span class="o">=</span><span class="mi">72</span>
</pre></div>
</div>
</li>
<li><p class="first"><strong>Intel 18.0.1 + MPT 2.18.</strong></p>
</li>
</ul>
<a class="reference internal image-reference" href="_images/new_htt_mpt.svg"><img alt="_images/new_htt_mpt.svg" src="_images/new_htt_mpt.svg" width="400px" /></a>
<ul class="simple">
<li><strong>GNU 8.1.0 + Mvapich2.2.</strong></li>
</ul>
<a class="reference internal image-reference" href="_images/new_htt_mvapich.svg"><img alt="_images/new_htt_mvapich.svg" src="_images/new_htt_mvapich.svg" width="400px" /></a>
<ul class="simple">
<li><strong>Intel 18.0.1 + GNU 8.1.0.</strong></li>
</ul>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">This is not an apples to apples comparision. But it still goes to show WRF’s performance across compilers. Our above scaling results suggests that GNU with MPT would do better over GNU with MVAPICH</p>
</div>
<a class="reference internal image-reference" href="_images/new_htt_mvapich_mpt.svg"><img alt="_images/new_htt_mvapich_mpt.svg" src="_images/new_htt_mvapich_mpt.svg" width="400px" /></a>
<ul>
<li><p class="first"><strong>Following are speedup comparisions when specifying:</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">PBS</span> <span class="o">-</span><span class="n">l</span> <span class="n">select</span><span class="o">=</span><span class="mi">2</span><span class="p">:</span><span class="n">ncpus</span><span class="o">=</span><span class="mi">36</span><span class="p">:</span><span class="n">mpiprocs</span><span class="o">=</span><span class="mi">72</span>
</pre></div>
</div>
</li>
<li><p class="first"><strong>Intel 18.0.1 MPT 2.18 NCPUS = 36</strong></p>
</li>
</ul>
<a class="reference internal image-reference" href="_images/new_htt_mpt_36.svg"><img alt="_images/new_htt_mpt_36.svg" src="_images/new_htt_mpt_36.svg" width="400px" /></a>
<div class="section" id="mvapich">
<h2><a class="toc-backref" href="#id6">Mvapich</a><a class="headerlink" href="#mvapich" title="Permalink to this headline">¶</a></h2>
<p>Mvapich provides several runtime options to optimize performance. It interfaces with [hwloc](<a class="reference external" href="https://www.open-mpi.org/projects/hwloc/">https://www.open-mpi.org/projects/hwloc/</a>) software package to provide various thread bindings.
Below are some comparisions done using various settings</p>
</div>
<div class="section" id="misc-hybrid-runs">
<h2><a class="toc-backref" href="#id7">Misc Hybrid Runs</a><a class="headerlink" href="#misc-hybrid-runs" title="Permalink to this headline">¶</a></h2>
<p>Below are some other hybrid run graphs with computation times, different thread binding strategies, etc. Using omplace gives the best performance. Use dplace if you want to manually specify cpu sets.</p>
<ul class="simple">
<li>Intel 18.0.1 Total Computation Time</li>
</ul>
<a class="reference internal image-reference" href="https://raw.githubusercontent.com/DixitPatel/WRF_Simulation/master/results/intel18_openmp_67_comp.png"><img alt="https://raw.githubusercontent.com/DixitPatel/WRF_Simulation/master/results/intel18_openmp_67_comp.png" src="https://raw.githubusercontent.com/DixitPatel/WRF_Simulation/master/results/intel18_openmp_67_comp.png" style="width: 400px;" /></a>
<a class="reference internal image-reference" href="https://raw.githubusercontent.com/DixitPatel/WRF_Simulation/master/results/intel17_openmp_16_comp.png"><img alt="https://raw.githubusercontent.com/DixitPatel/WRF_Simulation/master/results/intel17_openmp_16_comp.png" src="https://raw.githubusercontent.com/DixitPatel/WRF_Simulation/master/results/intel17_openmp_16_comp.png" style="width: 400px;" /></a>
<ul class="simple">
<li>Intel 17.0.1 Option 16 Simulation Time</li>
</ul>
<a class="reference internal image-reference" href="https://raw.githubusercontent.com/DixitPatel/WRF_Simulation/master/results/intel17_openmp_16_speed.png"><img alt="https://raw.githubusercontent.com/DixitPatel/WRF_Simulation/master/results/intel17_openmp_16_speed.png" src="https://raw.githubusercontent.com/DixitPatel/WRF_Simulation/master/results/intel17_openmp_16_speed.png" style="width: 400px;" /></a>
<ul class="simple">
<li>Intel 17.0.1 Option 67 Total Computation time and Simulation Time.</li>
</ul>
<a class="reference internal image-reference" href="https://raw.githubusercontent.com/DixitPatel/WRF_Simulation/master/results/intel17_openmp_67_comp.png"><img alt="https://raw.githubusercontent.com/DixitPatel/WRF_Simulation/master/results/intel17_openmp_67_comp.png" src="https://raw.githubusercontent.com/DixitPatel/WRF_Simulation/master/results/intel17_openmp_67_comp.png" style="width: 300px;" /></a>
<a class="reference internal image-reference" href="https://raw.githubusercontent.com/DixitPatel/WRF_Simulation/master/results/intel17_openmp_67_speed.png"><img alt="https://raw.githubusercontent.com/DixitPatel/WRF_Simulation/master/results/intel17_openmp_67_speed.png" src="https://raw.githubusercontent.com/DixitPatel/WRF_Simulation/master/results/intel17_openmp_67_speed.png" style="width: 300px;" /></a>
</div>
</div>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, Dixit Patel.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'0.0.1',
            LANGUAGE:'None',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  <script type="text/javascript" src="_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>